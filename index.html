<!DOCTYPE html>
<html>
  <head>
    <title>Table Navigator</title>
    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <p>
      Use the arrow keys to move between cells.
      (This means the left and right arrows no longer work to position the cursor within a cell.)
    </p>
    <p>Save this <a id="bookmarklet">bookmarklet</a> to have the same functionality on other pages.</p>
    <p>It should work well on this simple table structure:</p>

    <table>
      <tr>
        <td><input size="3"></td>
        <td><input size="3"></td>
        <td><input size="3"></td>
      </tr>
      <tr>
        <td><input size="3"></td>
        <td><input size="3"></td>
        <td><input size="3"></td>
      </tr>
      <tr>
        <td><input size="3"></td>
        <td><input size="3"></td>
        <td><input size="3"></td>
      </tr>
    </table>

    <p>Still working on supporting ugly complex tables like this:</p>
    <table>
      <thead>
        <tr>
          <td><input size="3"></td>
          <td><input size="3"></td>
          <td><input size="3"></td>
          <td><input size="3"></td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input size="1"><input size="1"></td>
          <td><div><input size="3"></div></td>
          <td><input size="3"></td>
        </tr>
        <tr>
          <td></td>
          <td><input size="3"></td>
          <td><div><div><input size="3"></div></div></td>
          <td><input size="3"></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td><input size="3"></td>
          <td><input size="3"></td>
          <td><input size="3"></td>
          <td></td>
        </tr>        
      </tfoot>
    </table>
    <script id="bookmarklet-src">
      // TODO: Factor this out as a bookmarklet.
      window.addEventListener('keydown', (e) => {
        console.log(e.key);
        if (e.key.startsWith('Arrow')) {
          let dx, dy;
          switch (e.key) {
            case 'ArrowUp': [dx, dy] = [0, -1]; break;
            case 'ArrowLeft': [dx, dy] = [-1, 0]; break;
            case 'ArrowRight': [dx, dy] = [1, 0]; break;
            case 'ArrowDown': [dx, dy] = [0, 1]; break;
          }
          // TODO: Walk up the tree: There might be wrapping elements.
          // TODO: What about <tbody>?
          const td = document.activeElement.parentElement;
          const tr = td.parentElement;
          const table = tr.parentElement;
          console.log(`row ${tr.rowIndex}, col ${td.cellIndex}`);

          const targetRowIndex = tr.rowIndex + dy;
          const targetCellIndex = td.cellIndex + dx;
          const targetCell = table.rows[targetRowIndex].cells[targetCellIndex];
          // TODO: Walk down the tree to find <input>.
          console.log(targetCell);
          targetCell.children[0].focus()
        }
      });
    </script>
    <script>
      const js = document.getElementById('bookmarklet-src').textContent;
      const minJs = js.replace(/\/\/.*/g, '').replace(/\s+/g, ' ');
      console.log(minJs);
      const url = 'javascript:' + encodeURIComponent(minJs)
      document.getElementById('bookmarklet').setAttribute('href', url);
    </script>
  </body>
</html>